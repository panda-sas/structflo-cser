<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Compound Panel Annotator</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: monospace; background: #1a1a1a; color: #ddd;
       height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

/* ── Toolbar ── */
#toolbar { background: #2a2a2a; padding: 7px 12px; display: flex;
           align-items: center; gap: 10px; border-bottom: 1px solid #444;
           flex-shrink: 0; flex-wrap: wrap; }
#toolbar label { color: #aaa; font-size: 12px; }
button { background: #3a3a3a; color: #ddd; border: 1px solid #555;
         padding: 4px 11px; cursor: pointer; font-family: monospace;
         font-size: 12px; border-radius: 3px; }
button:hover  { background: #4a4a4a; }
button.save   { background: #1e4a1e; border-color: #3a8a3a; color: #9f9; }
button.empty  { background: #2a2a4a; border-color: #4a4aaa; color: #aaf; }
button.danger { background: #4a1e1e; border-color: #aa3a3a; color: #f99; }
button:disabled { opacity: 0.35; cursor: default; }
#sep { color: #444; }
#page-info { color: #9f9; font-size: 13px; min-width: 110px; }
#progress   { color: #888; font-size: 11px; }
#status { color: #fa0; font-size: 12px; margin-left: auto; }

/* ── Layout ── */
#main { display: flex; flex: 1; overflow: hidden; }
#canvas-wrap { flex: 1; overflow: auto; padding: 12px; background: #111; }
#canvas-container { position: relative; display: inline-block; cursor: crosshair; }
canvas { position: absolute; top: 0; left: 0; }
#base-img { display: block; }

/* ── Sidebar ── */
#sidebar { width: 230px; background: #222; border-left: 1px solid #444;
           display: flex; flex-direction: column; flex-shrink: 0; }
#sidebar-header { padding: 9px 12px; font-size: 12px; color: #aaa;
                  border-bottom: 1px solid #444; display: flex;
                  justify-content: space-between; align-items: center; }
#box-list  { flex: 1; overflow-y: auto; padding: 5px; }
.box-row   { display: flex; align-items: center; gap: 5px; padding: 4px 6px;
             border-radius: 3px; font-size: 11px; cursor: pointer; }
.box-row:hover     { background: #2e2e2e; }
.box-row.selected  { background: #1e2e1e; }
.box-num    { color: #fa0; min-width: 18px; }
.box-coords { color: #777; flex: 1; font-size: 10px; }
.box-del    { color: #844; cursor: pointer; padding: 0 3px; font-size: 13px; }
.box-del:hover { color: #f66; }
#sidebar-footer { padding: 9px; border-top: 1px solid #444;
                  display: flex; flex-direction: column; gap: 6px; }

/* ── Welcome ── */
#welcome { margin: 30px; background: #222; border: 2px dashed #444;
           padding: 28px; border-radius: 6px; text-align: center; }
#welcome p { color: #888; font-size: 13px; line-height: 1.7; }
#welcome .hint { color: #555; font-size: 11px; margin-top: 14px; }

/* ── Page status badges ── */
.badge-done  { display: inline-block; background: #1e3a1e; color: #6d6;
               border-radius: 2px; padding: 0 4px; font-size: 10px; }
.badge-empty { display: inline-block; background: #2a2a3a; color: #88a;
               border-radius: 2px; padding: 0 4px; font-size: 10px; }
</style>
</head>
<body>

<div id="toolbar">
  <label>PDF:</label>
  <input type="file" id="pdf-input" accept=".pdf">
  <button id="upload-btn">Upload</button>

  <span class="sep">|</span>

  <button id="prev-btn" disabled>← Prev</button>
  <span id="page-info">No pages</span>
  <button id="next-btn" disabled>Next →</button>

  <span class="sep">|</span>

  <button id="save-btn"  class="save"   disabled>Save (S)</button>
  <button id="empty-btn" class="empty"  disabled>No Panels (E)</button>
  <button id="undo-btn"                 disabled>Undo (Z)</button>

  <span class="sep">|</span>

  <button id="export-btn" class="save" disabled>Export &amp; Save All</button>

  <span id="progress"></span>
  <span id="status">Upload a PDF to start</span>
</div>

<div id="main">
  <div id="canvas-wrap">
    <div id="welcome">
      <p>Upload a PDF using the toolbar above.<br>
         Browse pages with ← → arrows, then click and drag to draw<br>
         a bounding box around each compound panel.</p>
      <p class="hint">
        S = save &nbsp;·&nbsp; E = mark page as "no panels" &nbsp;·&nbsp;
        Z = undo last box &nbsp;·&nbsp; ← → = navigate (auto-saves)
      </p>
    </div>
    <div id="canvas-container" style="display:none">
      <img id="base-img" draggable="false">
      <canvas id="overlay"></canvas>
    </div>
  </div>

  <div id="sidebar">
    <div id="sidebar-header">
      <span id="sidebar-title">Boxes</span>
      <span id="sidebar-badge"></span>
    </div>
    <div id="box-list"></div>
    <div id="sidebar-footer">
      <button id="clear-btn" class="danger" disabled>Clear all boxes</button>
    </div>
  </div>
</div>

<script>
const DISPLAY_WIDTH = 900;

// State
let pages = [], pageIdx = 0;
let boxes = [], selectedBox = -1;
let imgW = 0, imgH = 0, scale = 1;
let isDrawing = false, sx = 0, sy = 0, cx = 0, cy = 0;
let dirty = false;

// DOM
const canvas   = document.getElementById('overlay');
const ctx      = canvas.getContext('2d');
const img      = document.getElementById('base-img');
const status   = document.getElementById('status');
const pageInfo = document.getElementById('page-info');
const progress = document.getElementById('progress');
const sidebarTitle = document.getElementById('sidebar-title');
const sidebarBadge = document.getElementById('sidebar-badge');

// ── Upload ────────────────────────────────────────────────────────────────────
document.getElementById('upload-btn').addEventListener('click', async () => {
  const file = document.getElementById('pdf-input').files[0];
  if (!file) { setStatus('Select a PDF first.', 'warn'); return; }
  setStatus('Converting PDF…', 'info');
  const fd = new FormData();
  fd.append('pdf', file);
  const r = await fetch('/upload', {method: 'POST', body: fd});
  const data = await r.json();
  if (data.error) { setStatus(data.error, 'err'); return; }
  await refreshPages(0);
  setStatus(`Loaded ${data.pages.length} pages from "${file.name}".`, 'ok');
});

async function refreshPages(idx) {
  const r = await fetch('/pages');
  pages = await r.json();
  if (!pages.length) return;
  enableNav(true);
  pageIdx = Math.max(0, Math.min(idx, pages.length - 1));
  await loadPage(pageIdx);
}

// ── Navigation ────────────────────────────────────────────────────────────────
document.getElementById('prev-btn').addEventListener('click', () => navigate(-1));
document.getElementById('next-btn').addEventListener('click', () => navigate(1));

async function navigate(dir) {
  if (dirty) await saveCurrent();
  pageIdx = Math.max(0, Math.min(pages.length - 1, pageIdx + dir));
  await loadPage(pageIdx);
}

async function loadPage(idx) {
  const p = pages[idx];
  pageInfo.textContent = `Page ${idx + 1} / ${pages.length}`;
  sidebarTitle.textContent = `Boxes — ${idx + 1}/${pages.length}`;
  updateProgress();

  // Swap image
  document.getElementById('welcome').style.display = 'none';
  document.getElementById('canvas-container').style.display = 'inline-block';

  await new Promise(resolve => {
    img.onload = resolve;
    img.src = `/image/${p.id}?t=${Date.now()}`;
  });

  // Scale canvas to fit display width
  const dw = Math.min(DISPLAY_WIDTH, p.w);
  scale = dw / p.w;
  const dh = Math.round(p.h * scale);
  img.style.width  = dw + 'px';
  img.style.height = dh + 'px';
  canvas.width  = dw;
  canvas.height = dh;
  imgW = p.w; imgH = p.h;

  // Load existing annotations
  const ann = await fetch(`/annotations/${p.id}`).then(r => r.json());
  boxes       = ann.boxes || [];
  dirty       = false;
  selectedBox = -1;

  // Sidebar badge: annotated state
  if (ann.annotated && boxes.length === 0) {
    sidebarBadge.innerHTML = '<span class="badge-empty">∅ empty</span>';
  } else if (ann.annotated) {
    sidebarBadge.innerHTML = `<span class="badge-done">${boxes.length} box(es)</span>`;
  } else {
    sidebarBadge.textContent = '';
  }

  redraw();
  renderBoxList();
  setStatus(ann.annotated
    ? `${boxes.length} box(es) on this page.`
    : 'Not yet annotated.', 'ok');
}

// ── Drawing ───────────────────────────────────────────────────────────────────
canvas.addEventListener('mousedown', e => {
  if (e.button !== 0) return;
  isDrawing = true;
  const r = canvas.getBoundingClientRect();
  sx = cx = e.clientX - r.left;
  sy = cy = e.clientY - r.top;
});

canvas.addEventListener('mousemove', e => {
  if (!isDrawing) return;
  const r = canvas.getBoundingClientRect();
  cx = e.clientX - r.left;
  cy = e.clientY - r.top;
  redraw();
});

canvas.addEventListener('mouseup', e => {
  if (!isDrawing) return;
  isDrawing = false;
  const r = canvas.getBoundingClientRect();
  const ex = e.clientX - r.left, ey = e.clientY - r.top;
  if (Math.abs(ex - sx) > 12 && Math.abs(ey - sy) > 12) {
    boxes.push({
      x1: Math.round(Math.min(sx, ex) / scale),
      y1: Math.round(Math.min(sy, ey) / scale),
      x2: Math.round(Math.max(sx, ex) / scale),
      y2: Math.round(Math.max(sy, ey) / scale),
    });
    dirty = true;
    renderBoxList();
    setStatus(`${boxes.length} box(es). Press S to save.`, 'warn');
  }
  redraw();
});

function redraw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  boxes.forEach((b, i) => {
    const x = b.x1 * scale, y = b.y1 * scale;
    const w = (b.x2 - b.x1) * scale, h = (b.y2 - b.y1) * scale;
    ctx.strokeStyle = i === selectedBox ? '#ffff00' : '#00e87a';
    ctx.lineWidth   = i === selectedBox ? 2.5 : 1.5;
    ctx.strokeRect(x, y, w, h);
    ctx.fillStyle = ctx.strokeStyle;
    ctx.font = 'bold 11px monospace';
    ctx.fillText(i, x + 3, y + 13);
  });

  if (isDrawing) {
    ctx.strokeStyle = '#ff4444';
    ctx.lineWidth = 1.5;
    ctx.setLineDash([5, 3]);
    ctx.strokeRect(sx, sy, cx - sx, cy - sy);
    ctx.setLineDash([]);
  }
}

// ── Sidebar box list ──────────────────────────────────────────────────────────
function renderBoxList() {
  const list = document.getElementById('box-list');
  list.innerHTML = '';
  if (!boxes.length) {
    list.innerHTML = '<div style="color:#555;font-size:11px;padding:8px">No boxes drawn</div>';
    return;
  }
  boxes.forEach((b, i) => {
    const el = document.createElement('div');
    el.className = 'box-row' + (i === selectedBox ? ' selected' : '');
    el.innerHTML =
      `<span class="box-num">${i}</span>` +
      `<span class="box-coords">${b.x1},${b.y1}→${b.x2},${b.y2}</span>` +
      `<span class="box-del" title="Delete box ${i}">×</span>`;
    el.querySelector('.box-del').addEventListener('click', e => {
      e.stopPropagation(); deleteBox(i);
    });
    el.addEventListener('click', () => {
      selectedBox = selectedBox === i ? -1 : i;
      renderBoxList(); redraw();
    });
    list.appendChild(el);
  });
}

function deleteBox(i) {
  boxes.splice(i, 1);
  if (selectedBox >= boxes.length) selectedBox = -1;
  dirty = true;
  redraw(); renderBoxList();
  setStatus(`Deleted box ${i}. ${boxes.length} remaining.`, 'warn');
}

// ── Save ──────────────────────────────────────────────────────────────────────
document.getElementById('save-btn').addEventListener('click', saveCurrent);

document.getElementById('empty-btn').addEventListener('click', async () => {
  // "No panels on this page" — clears boxes and saves [] explicitly
  if (boxes.length && !confirm('Clear all boxes and mark page as "no panels"?')) return;
  boxes = [];
  dirty = true;
  redraw(); renderBoxList();
  await saveCurrent();
  setStatus('Page marked as "no panels".', 'ok');
  sidebarBadge.innerHTML = '<span class="badge-empty">∅ empty</span>';
});

document.getElementById('undo-btn').addEventListener('click', () => {
  if (boxes.length) deleteBox(boxes.length - 1);
});

document.getElementById('clear-btn').addEventListener('click', () => {
  if (!confirm(`Delete all ${boxes.length} boxes on this page?`)) return;
  boxes = []; dirty = true; redraw(); renderBoxList();
  setStatus('Cleared. Press S to save.', 'warn');
});

async function saveCurrent() {
  if (!pages.length) return;
  const p = pages[pageIdx];
  const r = await fetch(`/annotations/${p.id}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({boxes}),
  });
  const data = await r.json();
  dirty = false;
  pages[pageIdx].annotated = true;
  pages[pageIdx].n_boxes   = data.saved;
  updateProgress();
  setStatus(`Saved ${data.saved} box(es).`, 'ok');
  if (data.saved === 0) {
    sidebarBadge.innerHTML = '<span class="badge-empty">∅ empty</span>';
  } else {
    sidebarBadge.innerHTML = `<span class="badge-done">${data.saved} box(es)</span>`;
  }
}

// ── Progress bar ──────────────────────────────────────────────────────────────
function updateProgress() {
  if (!pages.length) { progress.textContent = ''; return; }
  const done = pages.filter(p => p.annotated).length;
  progress.textContent = `${done}/${pages.length} annotated`;
  progress.style.color = done === pages.length ? '#9f9' : '#888';
}

// ── Helpers ───────────────────────────────────────────────────────────────────
document.getElementById('export-btn').addEventListener('click', async () => {
  const annotated = pages.filter(p => p.annotated).length;
  const pending   = pages.filter(p => !p.annotated).length;
  const msg = `Export ${annotated} annotated page(s) to images/?` +
    (pending ? `\n\n${pending} unannotated page(s) will be discarded.` : '') +
    '\n\nTmp images will be deleted and the session will reset.';
  if (!confirm(msg)) return;

  if (dirty) await saveCurrent();
  setStatus('Exporting…', 'info');

  const r    = await fetch('/export', {method: 'POST'});
  const data = await r.json();

  // Reset UI
  pages = []; pageIdx = 0; boxes = []; dirty = false;
  document.getElementById('welcome').style.display = 'block';
  document.getElementById('canvas-container').style.display = 'none';
  pageInfo.textContent   = 'No pages';
  progress.textContent   = '';
  sidebarTitle.textContent = 'Boxes';
  sidebarBadge.textContent = '';
  document.getElementById('box-list').innerHTML = '';
  enableNav(false);

  setStatus(
    `Done — ${data.exported} page(s) saved to images/, ${data.skipped} discarded.`,
    'ok'
  );
});

function enableNav(on) {
  ['prev-btn','next-btn','save-btn','empty-btn','undo-btn','clear-btn','export-btn']
    .forEach(id => document.getElementById(id).disabled = !on);
}

function setStatus(msg, level = 'ok') {
  status.textContent = msg;
  status.style.color = {ok:'#9f9', warn:'#fa0', err:'#f66', info:'#88f'}[level] ?? '#ddd';
}

// ── Keyboard shortcuts ────────────────────────────────────────────────────────
document.addEventListener('keydown', async e => {
  if (e.target.tagName === 'INPUT') return;
  if (e.key === 's' || e.key === 'S') { await saveCurrent(); }
  if (e.key === 'e' || e.key === 'E') { document.getElementById('empty-btn').click(); }
  if (e.key === 'z' || e.key === 'Z') { if (boxes.length) deleteBox(boxes.length - 1); }
  if (e.key === 'ArrowRight') { await navigate(1); }
  if (e.key === 'ArrowLeft')  { await navigate(-1); }
});
</script>
</body>
</html>
